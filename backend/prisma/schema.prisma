generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model audit_logs {
  id          BigInt    @id @default(autoincrement())
  user_id     Int?
  action      String
  object_type String?
  object_id   String?
  payload     Json?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  users       users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model customers {
  id             Int              @id @default(autoincrement())
  name           String?
  phone          String?
  email          String?
  loyalty_id     String?
  created_at     DateTime?        @default(now()) @db.Timestamptz(6)
  invoices       invoices[]
  loyalty_points loyalty_points[]
  returns        returns[]

  @@index([phone], map: "idx_customers_phone")
}

model inventories {
  id               Int               @id @default(autoincrement())
  store_id         Int?
  variant_id       Int?
  quantity         Decimal?          @default(0) @db.Decimal
  reserved         Decimal?          @default(0) @db.Decimal
  last_cost        Decimal?          @db.Decimal(14, 2)
  last_update      DateTime?         @default(now()) @db.Timestamptz(6)
  stores           stores?           @relation(fields: [store_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_variants product_variants? @relation(fields: [variant_id], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@unique([store_id, variant_id])
  @@index([store_id], map: "idx_inventories_store")
  @@index([store_id, variant_id], map: "idx_inventories_store_variant")
}

model invoice_items {
  id               Int               @id @default(autoincrement())
  invoice_id       Int?
  variant_id       Int?
  quantity         Decimal           @db.Decimal
  unit_price       Decimal           @db.Decimal(14, 2)
  unit_cost        Decimal?          @db.Decimal(14, 2)
  line_total       Decimal?          @db.Decimal(18, 2)
  invoices         invoices?         @relation(fields: [invoice_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_variants product_variants? @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  return_items     return_items[]

  @@index([variant_id], map: "idx_invoice_items_variant")
}

model invoices {
  id             Int             @id @default(autoincrement())
  invoice_number String?         @unique
  store_id       Int?
  customer_id    Int?
  subtotal       Decimal?        @default(0) @db.Decimal(18, 2)
  tax            Decimal?        @default(0) @db.Decimal(14, 2)
  discount       Decimal?        @default(0) @db.Decimal(14, 2)
  total          Decimal         @default(0) @db.Decimal(18, 2)
  payment_method String?
  created_by     Int?
  created_at     DateTime?       @default(now()) @db.Timestamptz(6)
  invoice_items  invoice_items[]
  returns        returns[]
  users          users?          @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  customers      customers?      @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stores         stores?         @relation(fields: [store_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_at], map: "idx_invoices_created_at")
  @@index([store_id], map: "idx_invoices_store")
  @@index([store_id, created_at], map: "idx_invoices_store_created_at")
}

model loyalty_points {
  id          Int        @id @default(autoincrement())
  customer_id Int?
  points      Int
  source      String?
  created_at  DateTime?  @default(now()) @db.Timestamptz(6)
  customers   customers? @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model product_variants {
  id                   Int                    @id @default(autoincrement())
  product_id           Int?
  variant_code         String?
  name                 String?
  barcode              String?                @unique
  price                Decimal                @default(0) @db.Decimal(14, 2)
  cost_price           Decimal?               @default(0) @db.Decimal(14, 2)
  min_stock            Decimal?               @db.Decimal
  is_active            Boolean?               @default(true)
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  inventories          inventories[]
  invoice_items        invoice_items[]
  return_items         return_items[]
  products             products?              @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  purchase_items       purchase_items[]
  purchase_order_receipt_items purchase_order_receipt_items[]
  stock_lots           stock_lots[]
  stock_movements      stock_movements[]
  store_transfer_items store_transfer_items[]
  variant_prices        variant_prices[]

  @@unique([product_id, variant_code])
  @@index([barcode], map: "idx_variants_barcode")
  @@index([variant_code], map: "idx_variants_variant_code")
}

model products {
  id               Int                @id @default(autoincrement())
  sku              String?            @unique
  name             String
  brand            String?
  category         String?
  brand_id         Int?
  category_id      Int?
  description      String?
  unit             String
  is_active        Boolean?           @default(true)
  created_at       DateTime?          @default(now()) @db.Timestamptz(6)
  product_variants product_variants[]

  brands           brands?            @relation(fields: [brand_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  categories       categories?        @relation(fields: [category_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([name], map: "idx_products_name")
  @@index([brand_id], map: "idx_products_brand_id")
  @@index([category_id], map: "idx_products_category_id")
}

model promotions {
  id              Int          @id @default(autoincrement())
  code            String       @unique
  name            String
  description     String?
  type            DiscountType
  value           Decimal      @db.Decimal(65, 30)
  start_date      DateTime
  end_date        DateTime
  min_order_value Decimal?     @db.Decimal(65, 30)
  max_discount    Decimal?     @db.Decimal(65, 30)
  is_active       Boolean      @default(true)
  scope           String       @default("all")
  store_codes     String[]     @default([])
  usage_count     Int          @default(0)
  created_at      DateTime     @default(now())
  updated_at      DateTime

  @@index([code], map: "idx_promotions_code")
}

model complaints {
  id            Int       @id @default(autoincrement())
  code          String?   @unique
  store_id      String?   @db.Text
  employee_id   String?   @db.Text
  store_name    String
  employee_name String
  reason        String
  description   String
  image         String?
  status        String    @default("Chờ xử lý")
  admin_note    String?
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @updatedAt @db.Timestamptz(6)
  resolved_at   DateTime? @db.Timestamptz(6)

  @@index([code], map: "idx_complaints_code")
  @@index([status], map: "idx_complaints_status")
  @@index([created_at], map: "idx_complaints_created_at")
  @@index([employee_id], map: "idx_complaints_employee_id")
  @@index([store_id], map: "idx_complaints_store_id")
}

model purchase_items {
  id                Int               @id @default(autoincrement())
  purchase_order_id Int?
  variant_id        Int?
  quantity          Decimal           @db.Decimal
  received_quantity Decimal           @default(0) @db.Decimal
  unit_cost         Decimal           @db.Decimal(14, 2)
  line_total        Decimal?          @db.Decimal(18, 2)
  purchase_orders   purchase_orders?  @relation(fields: [purchase_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_variants  product_variants? @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  purchase_order_receipt_items purchase_order_receipt_items[]
}

model purchase_orders {
  id             Int              @id @default(autoincrement())
  supplier_id    Int?
  store_id       Int?
  order_number   String?          @unique
  status         String?          @default("draft")
  total_amount   Decimal?         @default(0) @db.Decimal(18, 2)
  created_by     Int?
  created_at     DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?        @default(now()) @db.Timestamptz(6)
  purchase_items purchase_items[]
  purchase_order_receipts purchase_order_receipts[]
  users          users?           @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stores         stores?          @relation(fields: [store_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  suppliers      suppliers?       @relation(fields: [supplier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([store_id], map: "idx_purchase_orders_store")
  @@index([supplier_id], map: "idx_purchase_orders_supplier")
  @@index([store_id, created_at], map: "idx_purchase_orders_store_created_at")
}

model roles {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  users       users[]
  user_stores user_stores[]
}

model stock_lots {
  id                 Int               @id @default(autoincrement())
  variant_id         Int?
  store_id           Int?
  lot_code           String?
  quantity           Decimal           @db.Decimal
  quantity_remaining Decimal           @db.Decimal
  cost               Decimal?          @db.Decimal(14, 2)
  received_at        DateTime?         @default(now()) @db.Timestamptz(6)
  expiry_date        DateTime?         @db.Date
  stores             stores?           @relation(fields: [store_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product_variants   product_variants? @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([variant_id, store_id], map: "idx_stock_lots_variant_store")
}

model stock_movements {
  id               BigInt            @id @default(autoincrement())
  store_id         Int?
  variant_id       Int?
  change           Decimal           @db.Decimal
  movement_type    String
  reference_id     String?
  reason           String?
  created_by       Int?
  created_at       DateTime?         @default(now()) @db.Timestamptz(6)
  users            users?            @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stores           stores?           @relation(fields: [store_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product_variants product_variants? @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([store_id, created_at], map: "idx_stock_movements_store_time")
  @@index([variant_id], map: "idx_stock_movements_variant")
}

model store_transfer_items {
  id               Int               @id @default(autoincrement())
  transfer_id      Int?
  variant_id       Int?
  quantity         Decimal           @db.Decimal
  received_quantity Decimal          @default(0) @db.Decimal
  store_transfers  store_transfers?  @relation(fields: [transfer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_variants product_variants? @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model store_transfers {
  id                                           Int                    @id @default(autoincrement())
  transfer_number                              String?                @unique
  from_store_id                                Int?
  to_store_id                                  Int?
  status                                       String?                @default("pending")
  created_by                                   Int?
  created_at                                   DateTime?              @default(now()) @db.Timestamptz(6)
  store_transfer_items                         store_transfer_items[]
  users                                        users?                 @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stores_store_transfers_from_store_idTostores stores?                @relation("store_transfers_from_store_idTostores", fields: [from_store_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stores_store_transfers_to_store_idTostores   stores?                @relation("store_transfers_to_store_idTostores", fields: [to_store_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([from_store_id, created_at], map: "idx_store_transfers_from_store_created_at")
  @@index([to_store_id, created_at], map: "idx_store_transfers_to_store_created_at")
}

model stores {
  id                                                    Int               @id @default(autoincrement())
  code                                                  String            @unique
  name                                                  String
  address                                               String?
  phone                                                 String?
  timezone                                              String?           @default("Asia/Ho_Chi_Minh")
  is_active                                             Boolean?          @default(true)
  created_at                                            DateTime?         @default(now()) @db.Timestamptz(6)
  inventories                                           inventories[]
  invoices                                              invoices[]
  purchase_orders                                       purchase_orders[]
  purchase_order_receipts                               purchase_order_receipts[]
  returns                                               returns[]
  pos_shifts                                            pos_shifts[]
  cash_movements                                        cash_movements[]
  user_stores                                           user_stores[]
  variant_prices                                        variant_prices[]
  stock_lots                                            stock_lots[]
  stock_movements                                       stock_movements[]
  store_transfers_store_transfers_from_store_idTostores store_transfers[] @relation("store_transfers_from_store_idTostores")
  store_transfers_store_transfers_to_store_idTostores   store_transfers[] @relation("store_transfers_to_store_idTostores")
  users                                                 users[]
}

model suppliers {
  id              Int               @id @default(autoincrement())
  name            String
  contact_name    String?
  phone           String?
  email           String?
  address         String?
  note            String?
  created_at      DateTime?         @default(now()) @db.Timestamptz(6)
  purchase_orders purchase_orders[]
  purchase_order_receipts purchase_order_receipts[]

  @@index([name], map: "idx_suppliers_name")
}

model users {
  id              Int               @id @default(autoincrement())
  username        String            @unique
  password_hash   String
  full_name       String?
  email           String?           @unique
  phone           String?
  role_id         Int?
  store_id        Int?
  is_active       Boolean?          @default(true)
  created_at      DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?         @default(now()) @db.Timestamptz(6)
  audit_logs      audit_logs[]
  invoices        invoices[]
  purchase_orders purchase_orders[]
  purchase_order_receipts purchase_order_receipts[]
  stock_movements stock_movements[]
  store_transfers store_transfers[]
  returns         returns[]
  pos_shifts_opened pos_shifts[]    @relation("pos_shifts_opened")
  pos_shifts_closed pos_shifts[]    @relation("pos_shifts_closed")
  cash_movements   cash_movements[]
  user_stores      user_stores[]
  variant_prices   variant_prices[]
  roles           roles?            @relation(fields: [role_id], references: [id], onUpdate: NoAction)
  stores          stores?           @relation(fields: [store_id], references: [id], onUpdate: NoAction)
}

model user_stores {
  user_id    Int
  store_id   Int
  role_id    Int?
  is_primary Boolean?  @default(false)
  is_active  Boolean?  @default(true)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  users  users  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  stores stores @relation(fields: [store_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  roles  roles? @relation(fields: [role_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@id([user_id, store_id])
  @@index([store_id], map: "idx_user_stores_store")
  @@index([user_id], map: "idx_user_stores_user")
}

model categories {
  id         Int         @id @default(autoincrement())
  code       String      @unique
  name       String
  parent_id  Int?
  is_active  Boolean?    @default(true)
  created_at DateTime?   @default(now()) @db.Timestamptz(6)
  updated_at DateTime?   @default(now()) @db.Timestamptz(6)

  parent     categories? @relation("categories_parent", fields: [parent_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  children   categories[] @relation("categories_parent")
  products   products[]

  @@index([parent_id], map: "idx_categories_parent")
  @@index([name], map: "idx_categories_name")
}

model brands {
  id         Int       @id @default(autoincrement())
  code       String    @unique
  name       String
  is_active  Boolean?  @default(true)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  products   products[]

  @@index([name], map: "idx_brands_name")
}

model variant_prices {
  id         BigInt    @id @default(autoincrement())
  variant_id Int
  store_id   Int
  price      Decimal   @db.Decimal(14, 2)
  start_at   DateTime  @db.Timestamptz(6)
  end_at     DateTime? @db.Timestamptz(6)
  created_by Int?
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  product_variants product_variants @relation(fields: [variant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  stores           stores           @relation(fields: [store_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users            users?           @relation(fields: [created_by], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([store_id, variant_id], map: "idx_variant_prices_store_variant")
  @@index([store_id, start_at], map: "idx_variant_prices_store_start")
  @@unique([store_id, variant_id, start_at])
}

model purchase_order_receipts {
  id                Int             @id @default(autoincrement())
  purchase_order_id Int
  supplier_id       Int?
  store_id          Int?
  receipt_number    String?         @unique
  supplier_invoice  String?
  status            String?         @default("received")
  received_at       DateTime?       @default(now()) @db.Timestamptz(6)
  note              String?
  total_cost        Decimal?        @default(0) @db.Decimal(18, 2)
  created_by        Int?
  created_at        DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at        DateTime?       @default(now()) @db.Timestamptz(6)

  purchase_orders   purchase_orders @relation(fields: [purchase_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  suppliers         suppliers?      @relation(fields: [supplier_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  stores            stores?         @relation(fields: [store_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  users             users?          @relation(fields: [created_by], references: [id], onDelete: SetNull, onUpdate: NoAction)
  purchase_order_receipt_items purchase_order_receipt_items[]

  @@index([purchase_order_id], map: "idx_po_receipts_purchase_order")
  @@index([store_id, received_at], map: "idx_po_receipts_store_received_at")
}

model purchase_order_receipt_items {
  id                 Int                   @id @default(autoincrement())
  receipt_id         Int
  variant_id         Int
  purchase_item_id   Int?
  quantity_received  Decimal               @db.Decimal
  unit_cost          Decimal               @db.Decimal(14, 2)
  line_total         Decimal?              @db.Decimal(18, 2)
  lot_code           String?
  expiry_date        DateTime?             @db.Date

  purchase_order_receipts purchase_order_receipts @relation(fields: [receipt_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_variants        product_variants        @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  purchase_items          purchase_items?         @relation(fields: [purchase_item_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([receipt_id], map: "idx_po_receipt_items_receipt")
  @@index([variant_id], map: "idx_po_receipt_items_variant")
}

model returns {
  id            Int         @id @default(autoincrement())
  return_number String?     @unique
  invoice_id    Int?
  store_id      Int?
  customer_id   Int?
  status        String?     @default("draft")
  reason        String?
  note          String?
  total_refund  Decimal?    @default(0) @db.Decimal(18, 2)
  created_by    Int?
  created_at    DateTime?   @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?   @default(now()) @db.Timestamptz(6)

  invoices      invoices?   @relation(fields: [invoice_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  stores        stores?     @relation(fields: [store_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  customers     customers?  @relation(fields: [customer_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  users         users?      @relation(fields: [created_by], references: [id], onDelete: SetNull, onUpdate: NoAction)
  return_items  return_items[]

  @@index([store_id, created_at], map: "idx_returns_store_created_at")
  @@index([invoice_id], map: "idx_returns_invoice")
}

model return_items {
  id              Int               @id @default(autoincrement())
  return_id       Int
  invoice_item_id Int?
  variant_id      Int
  quantity        Decimal           @db.Decimal
  unit_price      Decimal?          @db.Decimal(14, 2)
  refund_amount   Decimal?          @db.Decimal(18, 2)
  reason          String?

  returns         returns           @relation(fields: [return_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  invoice_items   invoice_items?    @relation(fields: [invoice_item_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  product_variants product_variants @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([return_id], map: "idx_return_items_return")
  @@index([variant_id], map: "idx_return_items_variant")
}

model pos_shifts {
  id            Int       @id @default(autoincrement())
  store_id      Int
  status        String?   @default("open")
  opened_by     Int
  opened_at     DateTime  @default(now()) @db.Timestamptz(6)
  opening_cash  Decimal?  @default(0) @db.Decimal(14, 2)
  closed_by     Int?
  closed_at     DateTime? @db.Timestamptz(6)
  closing_cash  Decimal?  @db.Decimal(14, 2)
  note          String?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  stores        stores    @relation(fields: [store_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  opened_user   users     @relation("pos_shifts_opened", fields: [opened_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  closed_user   users?    @relation("pos_shifts_closed", fields: [closed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cash_movements cash_movements[]

  @@index([store_id, opened_at], map: "idx_pos_shifts_store_opened_at")
  @@index([status], map: "idx_pos_shifts_status")
}

model cash_movements {
  id          BigInt    @id @default(autoincrement())
  store_id    Int
  shift_id    Int?
  type        String
  amount      Decimal   @db.Decimal(14, 2)
  reason      String?
  created_by  Int?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  stores      stores    @relation(fields: [store_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  pos_shifts  pos_shifts? @relation(fields: [shift_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  users       users?    @relation(fields: [created_by], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([store_id, created_at], map: "idx_cash_movements_store_created_at")
  @@index([shift_id], map: "idx_cash_movements_shift")
}
